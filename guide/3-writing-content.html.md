---
title: Writing content for eBooks generated by epubtools
layout: ebook-page.html.ejs
---

Generally speaking the directory from which you create the EPUB bundle must contain HTML files written in the HTML-subset required by EPUB3.  However you arrange these HTML files to be generated is up to you.  You could use an HTML editor and create them directly, for example.

That could be the end of this chapter, right?  Just do what you need to do.  But, we want to give advice on a simple and easy-to-use system.

Markdown is a very fine format in which we create simple text files that can easily be converted to HTML.  There are several Markdown processors available, including for Node.js.  It would be possible to write a simple script to scan a directory tree for Markdown files, render them to HTML, outputting to the directory from which we create the EPUB bundle.  But the Markdown processors don't create a complete HTML file, and in any case it's useful to have some page layout flexibility.

I've written a static website generator system called AkashaCMS.  It is possible to use AkashaCMS to build the HTML for an EPUB.  However, lately I'm working on extracting the core rendering engine from AkashaCMS.  This module, AkashaRender, can be used much more flexibly than AkashaCMS was.

At the moment AkashaRender is used by creating a Node.js script similar to this:

```
'use strict';

const render = require('akasharender');

render.render({
    docdirs: [ 'documents' ],
    layoutDirs: [ 'layouts' ],
    partialDirs: [ 'partials' ],
    mahafuncs: [  ],
    headerScripts: {
        stylesheets: [ { href: 'css/style.css' } ],
        javaScriptTop: [],
        javaScriptBottom: []
    },
    cheerio: {
        recognizeSelfClosing: true,
        recognizeCDATA: true,
        xmlMode: true
    },
    renderTo: 'out'
})
.then(results => {
    for (var i = 0; i <  results.length; i++) {
        var result = results[i];
        if (result.error) {
            console.error(`RENDER ERROR ${result.fullpath} ==> ${result.error} ${result.error.stack}`);
        } else {
            console.log(result.result);
        }
    }
})
.catch(err => console.error(err.stack));
```

In other words, we call `render.render` with an options argument, it does its thing, and then we get a results object which is simply an array of results of trying to render everything.

# Configuration

```
docdirs: [ 'documents' ],
layoutDirs: [ 'layouts' ],
partialDirs: [ 'partials' ],
```

In AkashaRender we follow a model of having three arrays of input directories.  These are:

* __docdirs__ Lists where Documents are kept.  A Document is rendered by a Renderer to create an HTML file.
* __layoutDirs__  Lists where layout templates are kept.  A layout template takes a piece of rendered content, and wraps it within a page layout.  In a book you might have different sorts of pages for different purposes.
* __partialDirs__  Lists where content snippets or content snippet templates are kept.  A partial is similar to a page layout, but is meant to do a specific thing in a defined location on the page, rather than control the entire page layout.

```
headerScripts: {
    stylesheets: [ { href: 'css/style.css' } ],
    javaScriptTop: [],
    javaScriptBottom: []
},
```

This, especially the JavaScript portion, is primarily for website rendering.  We can use CSS files in an EPUB book, and this lets us do so.  Note that we do not use a leading '/' because EPUB does not use leading slashes on URL's.  Instead, every URL is relative to the current document.  AkashaRender makes sure to generate the correct relative URL.

```
mahafuncs: [  ],
cheerio: {
    recognizeSelfClosing: true,
    recognizeCDATA: true,
    xmlMode: true
},
```

This is for Mahabhuta, which is itself a very large topic.

```
renderTo: 'out'
```

This specifies the directory into which we render files.

# Specifying file names

AkashaRender has an extremely flexible rendering system that can potentially support any kind of input file, which is rendered to any kind of output file.  For our purposes here let's look at rendering Markdown files to HTML.

In AkashaRender, the document file has an extension identifying both the output format and the input format.  For Markdown the files are named as so:

```
input-file.html.md
```

The ".md" portion says it is in Markdown, and the ".html" portion says it outputs as HTML.  Internal to AkashaRender the conversion is done.

The directory hierarchy in the `renderTo` directory matches directly to the hierarchy in the `docdirs` directories.  That means a file stored as "path/to/xyzzy.html.md" will be rendered as "path/to/xyzzy.html".

# Per-page Metadata

AkashaRender uses "frontmatter" approach to storing metadata about a document.  That metadata gets carried through the rendering process and is available as data to rendering processes.

The format is as follows:

```
---
tagName: metadata value
tag2: metadata value 2
---

Document content
```

The metadata appears between the two --- lines.  The metadata block is structured with YAML markup.  While YAML is an immensely powerful markup language, in AkashaRender we can usually get away with simple tag:value items like is shown here.

# Layouts

One of the metadata items is `layout` which we'd write as so:

```
---
layout: page.html.ejs
---
```

This simply says to use the file named `page.html.ejs` as the template, looking in one of the deirectories named in the `layouts` directory.  The `.html.ejs` extension says to run the EJS renderer, and produce HTML output.

Suppose AkashaRender is working on a file named `xyzzy.html.md`, that has this frontmatter.

```
---
layout: page.html.ejs
title: The Fancy Schmancy Page Title
---
```

AkashaRender renders this file from Markdown to HTML.  It has two metadata values, `layout` and `title`.  It looks at the layout item, looks for the named page template, and might find this:

```
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<title><%= title %></title>
</head>
<body>
<%- content %>
</body>
</html>
```

This template is directly suitable for use in an EPUB3.

The rendered content from the first stage is available as the `content` variable.  In EJS the `<%- %>` tag says to output the variable with no interpolation, meaning it does not encode HTML tags but instead just copies the variable content to the output.  By contrast, the `<%= %>` tag, which is used for the `title` variable, does encode HTML tags.

In other words, xyzzy.html.md gets processed to HTML, then rendered into this template, and produces a new file named xyzzy.html.
